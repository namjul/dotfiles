#!/usr/bin/env zx

/**
# mise description="Symlinks dotfiles"
*/

const aspect = __dirname;
const files = path.join(aspect, "files");

await spinner("make directories", async () => {
  await $`mkdir -p ${os.homedir()}/.config`;
});

await spinner("create symlinks", async () => {
  const targetDir = os.homedir();
  const _files = await fs.readdir(files, {
    recursive: true,
    withFileTypes: true,
  });

  const linkFiles = (
    await Promise.all(
      _files.flatMap(async (dirent) => {
        if (!dirent.isFile()) {
          return [];
        }

        const isHardlink = dirent.name.startsWith("hard-");

        // Contstruct source and target paths
        const sourcePath = path.join(
          files,
          path.relative(files, path.join(dirent.parentPath, dirent.name)),
        );
        const targetPath = path.join(
          targetDir,
          path.relative(
            files,
            path.join(dirent.parentPath, dirent.name.replace(/^hard-/, "")),
          ),
        );

        // Ensure the target subdirectory exists
        const targetSubDir = path.dirname(targetPath);
        await fs.mkdir(targetSubDir, { recursive: true });

        try {
          await fs.access(targetPath);
          // console.log(`SKIP: ${relativePath}: already exists in ${targetDir}`);
          return [];
        } catch (err) {
          return { sourcePath, targetPath, link: isHardlink ? "hard" : "soft" };
        }
      }),
    )
  ).flat();

  if (!linkFiles.length) {
    console.log("No files to link");
  }

  for (const file of linkFiles) {
    if (file.link === "hard") {
      await $`ln -f "${file.sourcePath}" "${file.targetPath}"`;
      console.log(`HARDLINK: ${file.sourcePath} -> ${file.targetPath}`);
    } else {
      await $`ln -s "${file.sourcePath}" "${file.targetPath}"`;
      console.log(`SOFTLINK: ${file.sourcePath} -> ${file.targetPath}`);
    }
  }
});
