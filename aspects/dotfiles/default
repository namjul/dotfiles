#!/usr/bin/env zx

/**
# mise description="Symlinks dotfiles"
*/

const aspect = __dirname;
const files = path.join(aspect, "files");

await spinner("make directories", async () => {
  await $`mkdir -p ${os.homedir()}/.config`;
});

await spinner("create symlinks", async () => {
  const targetDir = os.homedir();
  const _files = await fs.readdir(files, {
    recursive: true,
    withFileTypes: true,
  });

  const linkFiles = (
    await Promise.all(
      _files.flatMap(async (dirent) => {
        if (!dirent.isFile()) {
          return [];
        }

        // Contstruct source and target paths
        const relativePath = path.relative(
          files,
          path.join(dirent.parentPath, dirent.name),
        );
        const sourcePath = path.join(files, relativePath);
        const targetPath = path.join(targetDir, relativePath);

        // Ensure the target subdirectory exists
        const targetSubDir = path.dirname(targetPath);
        await fs.mkdir(targetSubDir, { recursive: true });

        try {
          await fs.access(targetPath);
          // console.log(`SKIP: ${relativePath}: already exists in ${targetDir}`);
          return [];
        } catch (err) {
          return { sourcePath, targetPath };
        }
      }),
    )
  ).flat();

  if (!linkFiles.length) {
    console.log("No files to link");
  }

  for (const file of linkFiles) {
    await $`ln -s "${file.sourcePath}" "${file.targetPath}"`;
    console.log(`LINK: ${file.sourcePath} -> ${file.targetPath}`);
  }
});
